# pages/2_ğŸ“Š_PM10_ì‹œê°í™”.py
import streamlit as st
import pandas as pd
import altair as alt
import pydeck as pdk
from pathlib import Path

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 0. í˜ì´ì§€ ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(page_title="PM10 ì‹œê°í™”", page_icon="ğŸŒ«ï¸", layout="wide")
st.title("ğŸ“Š ì›”ë³„â€§ë„ì‹œë³„ ë¯¸ì„¸ë¨¼ì§€(PM10) ë°ì´í„° íƒêµ¬")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. CSV ë¡œë“œ í•¨ìˆ˜ (ë‹¤ì¤‘ ì¸ì½”ë”© ì‹œë„)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@st.cache_data
def try_read_csv(path_or_file):
    encodings = ["utf-8", "utf-8-sig", "cp949", "euc-kr"]
    for enc in encodings:
        try:
            df = pd.read_csv(path_or_file, encoding=enc)
            st.success(f"âœ… CSV íŒŒì¼ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤ (encoding='{enc}')")
            return df
        except UnicodeDecodeError:
            continue
    st.error("âŒ íŒŒì¼ ì¸ì½”ë”©ì„ ê°ì§€í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
    return None

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. CSV í™•ë³´ (ë¡œì»¬ íŒŒì¼ ë˜ëŠ” ì—…ë¡œë“œ)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DATA_PATH = Path(__file__).parent / "ë¯¸ì„¸ë¨¼ì§€_PM10__ì›”ë³„_ë„ì‹œë³„_ëŒ€ê¸°ì˜¤ì—¼ë„.csv"

if DATA_PATH.exists():
    df_wide = try_read_csv(DATA_PATH)
else:
    uploaded = st.file_uploader("ğŸ“¤ CSV íŒŒì¼ ì—…ë¡œë“œ", type=["csv"])
    if uploaded:
        df_wide = try_read_csv(uploaded)
    else:
        st.stop()          # íŒŒì¼ ì—†ìœ¼ë©´ ì´í›„ ì½”ë“œ ì¤‘ë‹¨

if df_wide is None:
    st.stop()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. ë°ì´í„° ì „ì²˜ë¦¬ (wide â†’ long)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
try:
    df_long = df_wide.melt(
        id_vars=[df_wide.columns[0]],           # ì²« ì—´ â†’ ì§€ì—­
        var_name="ì›”",
        value_name="PM10"
    ).rename(columns={df_wide.columns[0]: "ì§€ì—­"})

    # ì›”ì„ ë‚ ì§œí˜•ìœ¼ë¡œ ë³€í™˜í•´ ì •ë ¬ìš© ì»¬ëŸ¼ ì¶”ê°€
    df_long["ìˆœì„œ"] = pd.to_datetime(df_long["ì›”"], format="%Yë…„%mì›”", errors="coerce")
except Exception as e:
    st.error("ğŸ“› ë°ì´í„° ë³€í™˜ ì˜¤ë¥˜: " + str(e))
    st.stop()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.expander("ğŸ” ì›ë³¸ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°", expanded=False):
    st.dataframe(df_wide.head())

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. Altair ì„  ê·¸ë˜í”„ (ë„ì‹œë³„ ì›”ê°„ ì¶”ì„¸)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.subheader("â‘  ë„ì‹œë³„ ì›”ê°„ ì¶”ì„¸ (ì„  ê·¸ë˜í”„)")

city_options = df_long["ì§€ì—­"].unique().tolist()
sel_cities = st.multiselect(
    "ë„ì‹œ(ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)",
    city_options,
    default=["ì„œìš¸íŠ¹ë³„ì‹œ"]
)

if sel_cities:
    chart_data = df_long[df_long["ì§€ì—­"].isin(sel_cities)]
    
    # ì •ë ¬ ê¸°ì¤€ ë¦¬ìŠ¤íŠ¸ (ë¬¸ìì—´ ìˆœì„œ)
    month_order = (
        chart_data.sort_values("ìˆœì„œ")["ì›”"]
        .dropna()
        .unique()
        .tolist()
    )

    line_chart = (
        alt.Chart(chart_data)
        .mark_line(point=True)
        .encode(
            x=alt.X("ì›”:N", sort=month_order, title="ì—°â€§ì›”"),
            y=alt.Y("PM10:Q", title="PM10 ë†ë„(ã/ã¥)"),
            color="ì§€ì—­:N",
            tooltip=["ì§€ì—­", "ì›”", "PM10"]
        )
        .properties(height=400)
    )
    st.altair_chart(line_chart, use_container_width=True)
else:
    st.info("ì¢Œì¸¡ ì²´í¬ë°•ìŠ¤ì—ì„œ í•œ ê°œ ì´ìƒ ë„ì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”.")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6. ì›” ì„ íƒ â†’ pydeck ì§€ë„ (PM10 ìƒ‰ìƒ ë§¤í•‘)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.subheader("â‘¡ ì„ íƒ ì›” ì§€ë„ ì‹œê°í™”")
def pm10_level(value):
    if value <= 30:
        return "ì¢‹ìŒ"
    elif value <= 80:
        return "ë³´í†µ"
    elif value <= 150:
        return "ë‚˜ì¨"
    else:
        return "ë§¤ìš°ë‚˜ì¨"
        
month_cols = [c for c in df_wide.columns if c != "ì§€ì—­"]
sel_month = st.selectbox("ë³´ê³  ì‹¶ì€ ì›”", month_cols, index=len(month_cols) - 1)

# (1) ì¢Œí‘œ ì‚¬ì „
city_coords = {
    "ì„œìš¸íŠ¹ë³„ì‹œ": (37.5665, 126.9780), "ë¶€ì‚°ê´‘ì—­ì‹œ": (35.1796, 129.0756),
    "ëŒ€êµ¬ê´‘ì—­ì‹œ": (35.8714, 128.6014), "ì¸ì²œê´‘ì—­ì‹œ": (37.4563, 126.7052),
    "ê´‘ì£¼ê´‘ì—­ì‹œ": (35.1595, 126.8526), "ëŒ€ì „ê´‘ì—­ì‹œ": (36.3504, 127.3845),
    "ìš¸ì‚°ê´‘ì—­ì‹œ": (35.5384, 129.3114), "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ": (36.4800, 127.2890),
    "ê²½ê¸°ë„": (37.4133, 127.5183),   "ê°•ì›íŠ¹ë³„ìì¹˜ë„": (37.8228, 128.1555),
    "ì¶©ì²­ë¶ë„": (36.6358, 127.4914), "ì „ë¶íŠ¹ë³„ìì¹˜ë„": (35.8200, 127.1088),
    "ì „ë¼ë‚¨ë„": (34.8160, 126.4630), "ê²½ìƒë¶ë„": (36.4919, 128.8889),
    "ê²½ìƒë‚¨ë„": (35.4606, 128.2132), "ì œì£¼íŠ¹ë³„ìì¹˜ë„": (33.4996, 126.5312),
}

# (2) ìƒ‰ìƒ ë³€í™˜ í•¨ìˆ˜  â–¸ ë‚®ìŒ=ë…¹ìƒ‰, ë³´í†µ=ë…¸ë‘, ë†’ìŒ=ë¹¨ê°•
def pm_to_color(pm):
    if pd.isna(pm):
        return [200, 200, 200, 160]        # íšŒìƒ‰
    if pm <= 30:
        return [0, 200, 0, 160]            # ë…¹ìƒ‰
    elif pm <= 80:
        return [255, 215, 0, 160]          # ë…¸ë‘
    else:
        return [255, 0, 0, 160]            # ë¹¨ê°•

# (3) ì§€ë„ ë°ì´í„° í”„ë ˆì„
map_df = (
    df_wide[["ì§€ì—­", sel_month]]
    .assign(
        lat=lambda d: d["ì§€ì—­"].map(lambda x: city_coords[x][0]),
        lon=lambda d: d["ì§€ì—­"].map(lambda x: city_coords[x][1]),
        radius=lambda d: d[sel_month] * 500,
        pm=lambda d: d[sel_month],
        ë“±ê¸‰=lambda d: d[sel_month].apply(pm10_level)
    )
)

layer = pdk.Layer(
    "ScatterplotLayer",
    data=map_df,
    get_position="[lon, lat]",
    get_radius="radius",
    get_fill_color="[255, 100, 50, 160]",
    pickable=True,
    auto_highlight=True,
)

view_state = pdk.ViewState(latitude=36.5, longitude=127.8, zoom=5.5)

st.pydeck_chart(
    pdk.Deck(
        layers=[layer],
        initial_view_state=view_state,
        tooltip={"text": "{ì§€ì—­}\nPM10: {pm} ã/ã¥\në“±ê¸‰: {ë“±ê¸‰}"}
    )
)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 7. í† ë¡  ì§ˆë¬¸ Â· êµìœ¡ì  í•¨ì˜ Â· í™•ì¥ í™œë™
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("---")
st.subheader("ğŸ—£ï¸ í•™ìƒ í† ë¡  ì§ˆë¬¸")
st.markdown("""
1. **ë„ì‹œë³„Â·ê³„ì ˆë³„ë¡œ PM10 ë†ë„ê°€ ë‹¬ë¼ì§€ëŠ” ì£¼ëœ ìš”ì¸ì€ ë¬´ì—‡ì¼ê¹Œìš”?**  
2. **SDGs ëª©í‘œ 11 â€˜ì§€ì†ê°€ëŠ¥í•œ ë„ì‹œì™€ ê³µë™ì²´â€™** ë‹¬ì„±ì„ ìœ„í•´, ê° ë„ì‹œê°€ ì‹œí–‰í•  ìˆ˜ ìˆëŠ” ëŒ€ê¸°ì§ˆ ê°œì„  ì •ì±…ì€ ë¬´ì—‡ì´ ìˆì„ê¹Œìš”?  
3. **ì—¬ëŸ¬ë¶„ ì§€ì—­**ì˜ ì²´ê° ê³µê¸° ì§ˆê³¼ ë°ì´í„°ê°€ ë‹¤ë¥¸ ë¶€ë¶„ì´ ìˆë‹¤ë©´, ì™œ ê·¸ëŸ°ì§€ ê°€ì„¤ì„ ì„¸ì›Œë³´ì„¸ìš”.
""")

st.subheader("ğŸ“ êµìœ¡ì  í•¨ì˜")
st.markdown("""
- **ë°ì´í„° í•´ì„ ì—­ëŸ‰**: ì‹œê³„ì—´Â·ê³µê°„ ë°ì´í„°ë¥¼ í•¨ê»˜ ë¶„ì„í•˜ì—¬ íŒ¨í„´ê³¼ ìƒê´€ê´€ê³„ íŒŒì•…  
- **ê³¼í•™Â·ì‚¬íšŒ ìœµí•©**: ê¸°ìƒÂ·ì‚°ì—…Â·êµí†µ ìš”ì¸ê³¼ ì—°ê³„í•´ ê³¼í•™ì  ê·¼ê±° ê¸°ë°˜ ì •ì±… ì œì•ˆ  
- **SDGs ì—°ê²°**: ëŒ€ê¸°ì˜¤ì—¼ì´ ê±´ê°•(Goal 3), ê¸°í›„(Goal 13)ì™€ ë°€ì ‘íˆ ê´€ë ¨ë¨ì„ ì´í•´
""")

st.subheader("ğŸš€ í™•ì¥ í™œë™")
st.markdown("""
- **ê¸°ìƒ ë°ì´í„°(ê¸°ì˜¨Â·í’ì† ë“±)** ì¶”ê°€ í›„ ë‹¤ì¤‘ íšŒê·€ ë¶„ì„ìœ¼ë¡œ PM10 ì˜ˆì¸¡ ëª¨ë¸ ë§Œë“¤ê¸°  
- **ë‹¤ë¥¸ ëŒ€ê¸°ì˜¤ì—¼ë¬¼ì§ˆ(PM2.5Â·NOâ‚‚ ë“±)**ë¡œ ì§€í‘œ í™•ì¥ â†’ SDGs Goal 3Â·13 ì‹¬í™” íƒêµ¬  
- **í˜„ì¥ ì¤‘ì‹¬ í”„ë¡œì íŠ¸**: ì‹œì²­Â·ì˜íšŒì— ëŒ€ê¸° ê°œì„  ì •ì±… ì¸í¬ê·¸ë˜í”½ ë˜ëŠ” ì œì•ˆì„œ ì œì¶œ
""")
